module polyhedron_type_test

  use kinds, only: r8
  use polyhedron_type
  implicit none
  private

  public :: polyhedron_unit_test

contains

  subroutine polyhedron_unit_test ()

    use plane_type
    use polygon_type
    use hex_types,   only: hex_f, hex_e, cube_v
    use array_utils, only: isZero

    type(polyhedron) :: cube,pyramid,pyramid3,cutcube,tmp(2)
    type(polygon)    :: intpoly
    type(plane)      :: P
    real(r8)         :: volume,tmpr1,tmpr2
    logical          :: success
    integer          :: ierr
    real(r8)         :: pyr3_v(3,4) = reshape([ &
        0.0_r8, 0.0_r8, 0.0_r8, & ! vertex positions
        0.0_r8, 1.0_r8, 0.0_r8, &
        1.0_r8, 0.0_r8, 0.0_r8, &
        0.0_r8, 0.0_r8, 1.0_r8],&
        shape(pyr3_v))
    integer          :: pyr3_f(3,4) = reshape([ &
        1,2,3, & ! face vertices
        1,4,2, &
        1,3,4, &
        4,3,2],&
        shape(pyr3_f))
    integer          :: pyr3_e(2,6) = reshape([ &
        1,2, & ! edge vertices
        2,3, &
        3,4, &
        1,3, &
        4,1, &
        4,2],&
        shape(pyr3_e))
    real(r8)         :: pyr_v(3,5) = reshape([ & ! pyramid with square bottom
        0.0_r8, 0.0_r8, 0.0_r8, & ! vertex positions
        1.0_r8, 0.0_r8, 0.0_r8, &
        1.0_r8, 1.0_r8, 0.0_r8, &
        0.0_r8, 1.0_r8, 0.0_r8, &
        0.5_r8, 0.5_r8, 0.5_r8],&
        shape(pyr_v))
    integer          :: pyr_f(4,5) = reshape([ &
        1,2,3,4, & ! face vertices
        1,2,5,0, &
        2,3,5,0, &
        3,4,5,0, &
        4,1,5,0],&
        shape(pyr_f))
    integer          :: pyr_e(2,8) = reshape([ &
        1,2, & ! edge vertices
        2,3, &
        3,4, &
        4,1, &
        1,5, &
        2,5, &
        3,5, &
        4,5],&
        shape(pyr_e))
    real(r8)         :: cutcube_v(3,10) = reshape([ &
        0.9_r8, 0.0_r8, 0.0_r8, & ! cube cut with triangle face
        0.0_r8, 0.9_r8, 0.0_r8, &
        0.0_r8, 0.0_r8, 0.9_r8, &
        1.0_r8, 0.0_r8, 0.0_r8, &
        1.0_r8, 1.0_r8, 0.0_r8, &
        0.0_r8, 1.0_r8, 0.0_r8, &
        0.0_r8, 0.0_r8, 1.0_r8, &
        1.0_r8, 0.0_r8, 1.0_r8, &
        1.0_r8, 1.0_r8, 1.0_r8, &
        0.0_r8, 1.0_r8, 1.0_r8],&
        shape(cutcube_v))
    integer :: cutcube_f(5,7) = reshape([ &
        3,2,1,0,0, &
        7,3,1,4,8, &
        4,5,9,8,0, &
        10,9,5,6,0, &
        10,6,2,3,7, &
        1,2,6,5,4, &
        10,7,8,9,0],&
        shape(cutcube_f))
    integer :: cutcube_e(2,15) = reshape([ &
        1,2, &
        2,3, &
        3,1, &
        1,4, &
        4,5, &
        5,6, &
        6,2, &
        3,7, &
        7,8, &
        8,9, &
        10,9, &
        10,7, &
        10,6, &
        9,5, &
        8,4],  &
        shape(cutcube_e))

    write(*,*)
    write(*,*) 'POLYHEDRON'
    write(*,*) '===================================================='

    ! ! calculate the volume of a unit cube (1)
    ! write(*,*) 'SHAPE VOLUMES'
    ! call cube%init (ierr, cube_v, hex_f, hex_e)
    ! volume = cube%volume ()
    ! success = isZero (volume-1.0_r8)
    ! write(*,*) 'cube volume?                     ', success
    ! if (.not.success) write(*,*) 'volume: ',volume

    ! ! calculate the volume of a pyramid (1/6)
    ! call pyramid%init (ierr, pyr_v, pyr_f, pyr_e)
    ! volume = pyramid%volume ()
    ! success = isZero (volume-1.0_r8/6.0_r8)
    ! write(*,*) 'pyramid volume?                  ', success
    ! if (.not.success) write(*,*) 'volume: ',volume

    ! ! calculate the volume of a pyramid
    ! call pyramid%init (ierr, reshape([&
    !     3.7500000000000000000000000e-01_r8, 3.5937500000000000000000000e-01_r8, 2.0312500000000000000000000e-01_r8,&
    !     3.7500000000000000000000000e-01_r8, 3.7187838412018936473657504e-01_r8, 2.0312500000000000000000000e-01_r8,&
    !     3.7500000000000000000000000e-01_r8, 3.5937500000000000000000000e-01_r8, 2.0205613718049295068901472e-01_r8,&
    !     3.8156580412702972848748573e-01_r8, 3.5937500000000000000000000e-01_r8, 2.0312500000000000000000000e-01_r8], [3,4]), &
    !     reshape([&
    !     4, 1, 3,&
    !     3, 1, 2,&
    !     2, 1, 4,&
    !     4, 3, 2], [3,4]), reshape([&
    !     1, 3,&
    !     1, 4,&
    !     1, 2,&
    !     2, 3,&
    !     3, 4,&
    !     4, 2], [2,6]))
    ! volume = pyramid%volume ()
    ! success = volume > 0.0_r8
    ! write(*,*) 'pyramid2 volume?                 ', success
    ! if (.not.success) write(*,*) 'volume: ',volume

    ! ! calculate the volume of a pyramid
    ! call pyramid%init (ierr, reshape([&
    !     2.5000000000000000000000000e-01_r8, 2.5000000000000000000000000e-01_r8, 0.0000000000000000000000000e+00_r8,&
    !     2.5000000000000000000000000e-01_r8, 2.6287194342498776400418592e-01_r8, 0.0000000000000000000000000e+00_r8,&
    !     2.5000000000000000000000000e-01_r8, 2.5000000000000000000000000e-01_r8, -1.1618077816026584070385752e-04_r8,&
    !     2.6287373171168715302314922e-01_r8, 2.5000000000000000000000000e-01_r8, 0.0000000000000000000000000e+00_r8], [3,4]), &
    !     reshape([&
    !     4, 1, 3,&
    !     3, 1, 2,&
    !     2, 1, 4,&
    !     4, 3, 2], [3,4]), &
    !     reshape([&
    !     1, 3,&
    !     1, 4,&
    !     1, 2,&
    !     2, 3,&
    !     3, 4,&
    !     4, 2], [2,6]))
    ! volume = pyramid%volume ()
    ! success = volume > 0.0_r8
    ! write(*,*) 'pyramid3 volume?                 ', success
    ! if (.not.success) write(*,*) 'volume: ',volume

    ! ! calculate the volume of a pyramid (1/6)
    ! call pyramid3%init (ierr, pyr3_v, pyr3_f, pyr3_e)
    ! volume = pyramid3%volume ()
    ! write(*,*) 'pyramid3 volume?                 ', isZero (volume-1.0_r8/6.0_r8)

    ! ! calculate the volume of a "cutcube" (1-0.9**3/6)
    ! call cutcube%init (ierr, cutcube_v, cutcube_f, cutcube_e)
    ! volume = cutcube%volume ()
    ! write(*,*) 'cutcube volume?                  ', isZero (volume-(1.0_r8-0.9_r8**3/6.0_r8))

    ! ! calculate the volume of a "cutcube"
    ! call cutcube%init (ierr, reshape([&
    !     7.03125E-01_r8,    2.50000E-01_r8,    6.3092397329198735000943543E-01_r8,&
    !     6.87500E-01_r8,    2.65625E-01_r8,    6.3835968598238201909822465E-01_r8,&
    !     7.03125E-01_r8,    2.65625E-01_r8,    6.3231363915688509891310787E-01_r8,&
    !     7.03125E-01_r8,    2.65625E-01_r8,    6.3231362814843028452571616E-01_r8,&
    !     6.87500E-01_r8,    2.65625E-01_r8,    6.3835968087108196922230263E-01_r8,&
    !     6.87500E-01_r8,    2.50000E-01_r8,    6.3697002011748427019455221E-01_r8,&
    !     7.03125E-01_r8,    2.50000E-01_r8,    6.3092396677678574956615876E-01_r8], [3,7]), reshape([&
    !     5,   2,   3,   4,&
    !     7,   1,   6,   0,&
    !     6,   2,   5,   0,&
    !     4,   3,   1,   7,&
    !     3,   2,   6,   1,&
    !     7,   6,   5,   4], [4,6]), reshape([&
    !     1,   7,&
    !     3,   4,&
    !     2,   5,&
    !     1,   6,&
    !     2,   6,&
    !     2,   3,&
    !     3,   1,&
    !     4,   5,&
    !     5,   6,&
    !     6,   7,&
    !     7,   4], [2,11]))
    ! volume = cutcube%volume ()
    ! write(*,*) 'cutcube2 volume?                 ', volume > 0.0_r8

    ! ! calculate the volume of a "cutcube"
    ! call cutcube%init (ierr, reshape([&
    !     6.2500000000000000000000000E-01_r8,    4.9205247210652008904574473E-01_r8,    2.6562500000000000000000000E-01_r8,&
    !     6.2500000000000000000000000E-01_r8,    4.8437500000000000000000000E-01_r8,    2.5576988559870150741204498E-01_r8,&
    !     6.2500000000000000000000000E-01_r8,    4.9205228021985458752851628E-01_r8,    2.6562500000000000000000000E-01_r8,&
    !     6.2500000000000000000000000E-01_r8,    4.8437500000000000000000000E-01_r8,    2.5577007468008733370723462E-01_r8,&
    !     6.0962392793390562939492838E-01_r8,    4.8437500000000000000000000E-01_r8,    2.6523569565858362562238426E-01_r8,&
    !     6.0937500000000000000000000E-01_r8,    4.8455889840500104837062167E-01_r8,    2.6562500000000000000000000E-01_r8], [3,6]), &
    !     reshape([&
    !     5,   2,   4,   0,&
    !     4,   2,   1,   3,&
    !     3,   1,   6,   0,&
    !     6,   1,   2,   5,&
    !     6,   5,   4,   3], [4,5]), &
    !     reshape([&
    !     2,   4,&
    !     1,   3,&
    !     1,   6,&
    !     2,   5,&
    !     2,   1,&
    !     3,   4,&
    !     4,   5,&
    !     5,   6,&
    !     6,   3], [2,9]))
    ! volume = cutcube%volume ()
    ! write(*,*) 'cutcube3 volume?                 ', volume > 0.0_r8

    ! ! create a plane, and return coordinates it intersects with polyhedron edges
    ! write(*,*) 'SHAPE SPLITTING'
    ! P%normal = [ 1.0_r8, 0.0_r8, 0.0_r8 ]
    ! P%rho    = 0.5_r8

    ! ! intpoly = cube%intersection_verts (P)

    ! ! write(*,*) 'intersection points'
    ! ! do i = 1,intpoly%nVerts
    ! !   write(*,*) intpoly%x(:,i)
    ! ! end do

    ! ! split the cube vertically down the center
    ! !write(*,*) 'cube split volumes'
    ! call cube%split (P,tmp,ierr)
    ! success = isZero (tmp(1)%volume ()-0.5_r8) .and. isZero (tmp(2)%volume ()-0.5_r8)
    ! write(*,*) 'vertical cut?                    ',success

    ! ! split the cube at an angle
    ! P%normal = [ 1.0_r8, 1.0_r8, 0.0_r8 ] / sqrt(2.0_r8)
    ! P%rho    = 1.5_r8 / sqrt(2.0_r8)
    ! call cube%split (P,tmp,ierr)
    ! success = isZero (tmp(1)%volume ()-0.125_r8) .and. isZero (tmp(2)%volume ()-0.875_r8)
    ! write(*,*) 'xy-angle off-center cut?         ',success

    ! ! split the cube at an angle through the center
    ! P%normal = [ 1.0_r8, 1.0_r8, 0.0_r8 ] / sqrt(2.0_r8)
    ! P%rho    = 1.0_r8 / sqrt(2.0_r8)
    ! call cube%split (P,tmp,ierr)
    ! success = isZero (tmp(1)%volume ()-0.5_r8) .and. isZero (tmp(2)%volume ()-0.5_r8)
    ! write(*,*) 'center xy-angle cut?             ',success

    ! ! split the cube at an angle through the center
    ! P%normal = [ 1.0_r8, 1.0_r8, 1.0_r8 ] / sqrt(3.0_r8)
    ! P%rho    = 1.5_r8 / sqrt(3.0_r8)
    ! call cube%split (P,tmp,ierr)
    ! success = isZero (tmp(1)%volume ()-0.5_r8) .and. isZero (tmp(2)%volume ()-0.5_r8)
    ! write(*,*) 'center xyz-angle cut?            ',success

    ! ! split the cube at an angle through an offset
    ! P%normal = [ 1.0_r8, 1.0_r8, 1.0_r8 ] / sqrt(3.0_r8)
    ! P%rho    = 0.5_r8/sqrt(3.0_r8)
    ! call cube%split (P,tmp,ierr)
    ! success = isZero (tmp(1)%volume ()-47.0_r8/48.0_r8) .and. isZero (tmp(2)%volume ()-1.0_r8/48.0_r8)
    ! write(*,*) 'off-center xyz-angle cut?        ',success

    ! ! split the pyramid in the x direction
    ! P%normal = -[ 1.0_r8, 0.0_r8, 0.0_r8 ]
    ! P%rho    = -0.8_r8
    ! call pyramid3%split (P,tmp,ierr)
    ! success = isZero (tmp(1)%volume ()-0.992_r8/6.0_r8) .and. isZero (tmp(2)%volume ()-4e-3_r8/3.0_r8)
    ! write(*,*) 'pyramid3 cut?                    ',success

    ! ! split the cutcube
    ! P%normal = -[ 1.0_r8, 0.0_r8, 0.0_r8 ]
    ! P%rho    = -0.8_r8
    ! call cutcube%split (P,tmp,ierr)
    ! tmpr1 = 1.0_r8-0.9_r8**3/6.0_r8
    ! tmpr2 = 0.2_r8 - 0.1_r8**3/6.0_r8
    ! success = isZero (tmp(1)%volume ()-(tmpr1-tmpr2)) .and. isZero (tmp(2)%volume ()-tmpr2)
    ! write(*,*) 'cutcube cut?                     ',success

    ! ! split the cutcube2
    ! P%normal = [0.0_r8, -1.0_r8, 0.0_r8]
    ! P%rho    = -3.43734026719638874336E-01_r8
    ! call cutcube%init (ierr, reshape([&
    !     5.7537989065754502338023713E-01_r8,    3.28125E-01_r8,    5.00000E-01_r8,&
    !     5.7517531782297459663766404E-01_r8,    3.28125E-01_r8,    4.84375E-01_r8,&
    !     5.7213201658870560528669102E-01_r8,    3.43750E-01_r8,    4.84375E-01_r8,&
    !     5.7233658942327592100696165E-01_r8,    3.43750E-01_r8,    5.00000E-01_r8,&
    !     5.7213201762257304139325242E-01_r8,    3.43750E-01_r8,    4.84375E-01_r8,&
    !     5.7517531975197921934039869E-01_r8,    3.28125E-01_r8,    4.84375E-01_r8,&
    !     5.7537989252387589100834475E-01_r8,    3.28125E-01_r8,    5.00000E-01_r8], [3,7]), reshape([&
    !     3,   4,   5,   0,&
    !     1,   2,   6,   7,&
    !     2,   3,   5,   6,&
    !     1,   7,   4,   0,&
    !     3,   2,   1,   4,&
    !     7,   6,   5,   4], [4,6]), reshape([&
    !     2,   6,&
    !     3,   5,&
    !     1,   7,&
    !     1,   2,&
    !     2,   3,&
    !     3,   4,&
    !     1,   4,&
    !     4,   5,&
    !     5,   6,&
    !     6,   7,&
    !     7,   4], [2,11]))
    ! call cutcube%split (P,tmp,ierr)
    ! tmpr1 = 0.0_r8
    ! tmpr2 = 0.0_r8
    ! success = ierr==0
    ! write(*,*) 'cutcube2 cut?                     ',success,tmp(1)%volume(),tmp(2)%volume()

    ! ! split the cutcube3
    ! P%normal = [-1.1282635566E-01_r8, -5.757662896250E-01_r8, 8.097921913669E-01_r8]
    ! P%rho    = 9.69687230833222828241E-03_r8
    ! call cutcube%init (ierr, reshape([&
    !     3.1250000000000E-01_r8,    4.53125000000000E-01_r8,    3.75000000000000E-01_r8,&
    !     3.2812500000000E-01_r8,    4.53125000000000E-01_r8,    3.75000000000000E-01_r8,&
    !     3.2812500000000E-01_r8,    4.68750000000000E-01_r8,    3.75000000000000E-01_r8,&
    !     3.1250000000000E-01_r8,    4.68750000000000E-01_r8,    3.75000000000000E-01_r8,&
    !     3.2812500000000E-01_r8,    4.68750000000000E-01_r8,    3.90625000000000E-01_r8,&
    !     3.2812500000000E-01_r8,    4.68257797705384E-01_r8,    3.90625000000000E-01_r8,&
    !     3.2812500000000E-01_r8,    4.53125000000000E-01_r8,    3.79865503229404E-01_r8,&
    !     3.1250000000000E-01_r8,    4.53125000000000E-01_r8,    3.77688516622590E-01_r8,&
    !     3.1250000000000E-01_r8,    4.68750000000000E-01_r8,    3.88797971748706E-01_r8,&
    !     3.2561322556469E-01_r8,    4.68750000000000E-01_r8,    3.90625000000000E-01_r8], [3,10]), &
    !     reshape([&
    !     3,    4,   9,  10,   5,&
    !     1,    2,   7,   8,   0,&
    !     1,    8,   9,   4,   0,&
    !     2,    3,   5,   6,   7,&
    !     1,    4,   3,   2,   0,&
    !     5,   10,   6,   0,   0,&
    !     10,   9,   8,   7,   6], [5,7]), reshape([&
    !     1,    2,&
    !     2,    3,&
    !     3,    4,&
    !     4,    1,&
    !     1,    8,&
    !     2,    7,&
    !     3,    5,&
    !     4,    9,&
    !     5,    6,&
    !     5,   10,&
    !     6,    7,&
    !     7,    8,&
    !     8,    9,&
    !     9,   10,&
    !     10,   6], [2,15]))
    ! call cutcube%split (P,tmp,ierr)
    ! tmpr1 = 0.0_r8
    ! tmpr2 = 0.0_r8
    ! success = ierr==0
    ! write(*,*) 'cutcube3 cut?                     ',success,tmp(1)%volume(),tmp(2)%volume()

    ! ! split the cutcube4
    ! P%normal = [-1.93230506727E-01_r8, 4.44887220431205E-01_r8, -8.74492614243836E-01_r8]
    ! P%rho    = -2.71937202667160926595E-01_r8
    ! call cutcube%init (ierr, reshape([&
    !     3.437500000000000000E-01_r8, 2.96875000000000E-01_r8, 3.906250000000000000E-01_r8,&
    !     3.593750000000000000E-01_r8, 2.96875000000000E-01_r8, 3.906250000000000000E-01_r8,&
    !     3.593750000000000000E-01_r8, 3.12500000000000E-01_r8, 3.906250000000000000E-01_r8,&
    !     3.593750000000000000E-01_r8, 3.12500000000000E-01_r8, 3.905375988910991802E-01_r8,&
    !     3.589794501821763073E-01_r8, 3.12500000000000E-01_r8, 3.906250000000000000E-01_r8,&
    !     3.437500000000000000E-01_r8, 3.05885355602952E-01_r8, 3.906250000000000000E-01_r8,&
    !     3.437500000000000000E-01_r8, 2.96875000000000E-01_r8, 3.860410971129954460E-01_r8,&
    !     3.593750000000000000E-01_r8, 2.96875000000000E-01_r8, 3.825885804765565278E-01_r8], [3,8]), &
    !     reshape([&
    !     5,   3,   4,   0,   0,&
    !     8,   2,   1,   7,   0,&
    !     7,   1,   6,   0,   0,&
    !     4,   3,   2,   8,   0,&
    !     6,   1,   2,   3,   5,&
    !     8,   7,   6,   5,   4], [5,6]), reshape([&
    !     1,   7,&
    !     2,   8,&
    !     3,   4,&
    !     1,   2,&
    !     2,   3,&
    !     3,   5,&
    !     1,   6,&
    !     4,   5,&
    !     5,   6,&
    !     6,   7,&
    !     7,   8,&
    !     8,   4], [2,12]))
    ! call cutcube%split (P,tmp,ierr)
    ! tmpr1 = tmp(1)%volume()
    ! tmpr2 = tmp(2)%volume()
    ! success = ierr==0
    ! write(*,*) 'cutcube4 cut?                     ',success,tmpr1,tmpr2

    ! ! ! split the cutcube5
    ! ! P%normal = [3.55921787180000004369E-01_r8, -9.34506859900000041996E-01_r8, 4.07556263139999958023E-03_r8]
    ! ! P%rho    = -2.42551881899006921417E-01_r8
    ! ! call cutcube%init (ierr, reshape([&
    ! !     2.96875E-01_r8,    3.75000E-01_r8,    5.31250E-01_r8,&
    ! !     3.12500E-01_r8,    3.75000E-01_r8,    5.31250E-01_r8,&
    ! !     3.12500E-01_r8,    3.90625E-01_r8,    5.31250E-01_r8,&
    ! !     2.96875E-01_r8,    3.90625E-01_r8,    5.31250E-01_r8,&
    ! !     2.96875E-01_r8,    3.75000E-01_r8,    5.46875E-01_r8,&
    ! !     3.12500E-01_r8,    3.75000E-01_r8,    5.46875E-01_r8,&
    ! !     3.12500E-01_r8,    3.90625E-01_r8,    5.46875E-01_r8,&
    ! !     2.96875E-01_r8,    3.90625E-01_r8,    5.46875E-01_r8], [3,8]), hex_f, hex_e)
    ! ! call cutcube%split(P,tmp,ierr)
    ! ! success = ierr==0
    ! ! write(*,*) 'cutcube5 cut?                     ',success,tmp(1)%volume(),tmp(2)%volume()
    ! ! call tmp(1)%print_data()

    ! ! split the cutcube5
    ! P%normal = [-3.559249373021E-01_r8, 9.345056485104E-01_r8, -4.07822371163224E-03_r8]
    ! P%rho    = 2.42549038109635933802E-01_r8
    ! call cutcube%init (ierr, reshape([&
    !     3.1250000000000000000000000E-01_r8,    3.7500000000000000000000000E-01_r8,    5.3125000000000000000000000E-01_r8,&
    !     2.9687500000000000000000000E-01_r8,    3.7500000000000000000000000E-01_r8,    5.4687500000000000000000000E-01_r8,&
    !     3.1250000000000000000000000E-01_r8,    3.7500000000000000000000000E-01_r8,    5.4687500000000000000000000E-01_r8,&
    !     2.9687500000000000000000000E-01_r8,    3.7500525766029885188501680E-01_r8,    5.4687500000000000000000000E-01_r8,&
    !     2.9687500000000000000000000E-01_r8,    3.7500000000000000000000000E-01_r8,    5.4566944384477711338377048E-01_r8,&
    !     2.9704011309117928085754556E-01_r8,    3.7500000000000000000000000E-01_r8,    5.3125000000000000000000000E-01_r8,&
    !     3.1250000000000000000000000E-01_r8,    3.8088814359134498532810653E-01_r8,    5.3125000000000000000000000E-01_r8,&
    !     3.1250000000000000000000000E-01_r8,    3.8095628719611474011230712E-01_r8,    5.4687500000000000000000000E-01_r8], [3,8]), &
    !     reshape([&
    !     6,   1,   3,   2,   5,&
    !     5,   2,   4,   0,   0,&
    !     8,   3,   1,   7,   0,&
    !     7,   1,   6,   0,   0,&
    !     4,   2,   3,   8,   0,&
    !     8,   7,   6,   5,   4], [5,6]), reshape([&
    !     1,   6,&
    !     1,   7,&
    !     2,   5,&
    !     1,   3,&
    !     2,   3,&
    !     3,   8,&
    !     2,   4,&
    !     4,   5,&
    !     5,   6,&
    !     6,   7,&
    !     7,   8,&
    !     8,   4], [2,12]))
    ! tmpr1 = cutcube%volume()
    ! call cutcube%split (P,tmp,ierr)
    ! tmpr1 = 0.0_r8
    ! tmpr2 = 0.0_r8
    ! success = ierr==0 .and. tmp(1)%volume() > 0.0_r8
    ! write(*,*) 'cutcube5 cut?                     ',success !,tmp(1)%volume(),tmp(2)%volume()

    !call messy_test1()
    !call messy_test2()
    call messy_test3()

    write(*,*) '===================================================='
    write(*,*)

  end subroutine polyhedron_unit_test

  subroutine messy_test1()

    use plane_type

    integer :: ierr
    real(r8) :: vol
    real(r8), allocatable :: x(:,:)
    integer, allocatable :: edge_vid(:,:), face_vid(:,:)
    type(plane) :: P
    type(polyhedron) :: cell

    x = reshape([&
        2.9976788831814599189939941E-01_r8,    1.9699622204619460230645700E-01_r8,    4.8834043669769046369655285E-02_r8,&
        2.9726827957985696437859247E-01_r8,    1.9805413816430661455569862E-01_r8,   -3.5941252550752075811679731E-03_r8,&
        3.0446717240682730221124075E-01_r8,    2.4761332446208708657486852E-01_r8,   -3.9305483510423348120221831E-03_r8,&
        2.9757437242438516955544969E-01_r8,    2.5209021294004041457981202E-01_r8,    4.8112595358931156686033148E-02_r8,&
        3.4558753583462131775405624E-01_r8,    1.9959592599521741584922552E-01_r8,    5.1507993971782801978509525E-02_r8,&
        3.5312328049032037924348515E-01_r8,    1.9723427154558312301979583E-01_r8,   -3.6805048546259722282159021E-03_r8,&
        3.4627512474415833576557588E-01_r8,    2.5379538003339369156563521E-01_r8,   -3.1263090661391677860247995E-03_r8,&
        3.4742142924274371784676418E-01_r8,    2.5283661562953735346681583E-01_r8,    4.9878818088302780131559899E-02_r8,&
        3.2393452470452865910033324E-01_r8,    2.5158388326626462960788899E-01_r8,    2.2733639007513108121205647E-02_r8,&
        3.2393674605573619107445893E-01_r8,    1.9797013943782543199390034E-01_r8,    2.3266851882962666375753713E-02_r8,&
        3.2258780645497403538612957E-01_r8,    2.2537974415274744655057759E-01_r8,    4.9583362772196451495609892E-02_r8,&
        3.2528346430529075927751137E-01_r8,    2.2417427855134261505121174E-01_r8,   -3.5828718817206704934374972E-03_r8,&
        2.9976942818230384313338277E-01_r8,    2.2368847440315717256531514E-01_r8,    2.2355491355645663864581962E-02_r8,&
        3.4810184257796095153025817E-01_r8,    2.2586554830093291679204981E-01_r8,    2.3644999534830110632377398E-02_r8],&
        [3,14])

    edge_vid = reshape([&
        1,   2,&
        2,   3,&
        3,   4,&
        4,   1,&
        1,   5,&
        2,   6,&
        3,   7,&
        4,   8,&
        5,   6,&
        6,   7,&
        7,   8,&
        8,   5,&
        3,   9,&
        4,   9,&
        8,   9,&
        7,   9,&
        1,  10,&
        2,  10,&
        6,  10,&
        5,  10,&
        1,  11,&
        5,  11,&
        8,  11,&
        4,  11,&
        2,  12,&
        3,  12,&
        7,  12,&
        6,  12,&
        1,  13,&
        4,  13,&
        3,  13,&
        2,  13,&
        5,  14,&
        6,  14,&
        7,  14,&
        8,  14], [2,36])

    face_vid = reshape([&
        3,   4,   9,   0,&
        1,   2,  10,   0,&
        1,   5,  11,   0,&
        2,   3,  12,   0,&
        1,   4,  13,   0,&
        5,   6,  14,   0,&
        4,   8,   9,   0,&
        8,   7,   9,   0,&
        7,   3,   9,   0,&
        2,   6,  10,   0,&
        6,   5,  10,   0,&
        5,   1,  10,   0,&
        5,   8,  11,   0,&
        8,   4,  11,   0,&
        4,   1,  11,   0,&
        3,   7,  12,   0,&
        7,   6,  12,   0,&
        6,   2,  12,   0,&
        4,   3,  13,   0,&
        3,   2,  13,   0,&
        2,   1,  13,   0,&
        6,   7,  14,   0,&
        7,   8,  14,   0,&
        8,   5,  14,   0], [4,24])

    call cell%init(ierr, x, face_vid, edge_vid, tesselate=.false.)
    P%normal = [9.77934209139071253247E-01_r8, -1.98361012211626469570E-01_r8, 6.55560174958656344257E-02_r8]
    P%rho = 3.01713145792795733868E-01_r8

    vol = cell%volume_behind_plane(P, ierr)

  end subroutine messy_test1

  subroutine messy_test2()

    use plane_type

    integer :: ierr
    real(r8) :: vol
    real(r8), allocatable :: x(:,:)
    integer, allocatable :: edge_vid(:,:), face_vid(:,:)
    type(plane) :: P
    type(polyhedron) :: cell

    x = reshape([&
        3.0047733973419932240744856E-01_r8,    1.5403199312752494098965883E-01_r8,    4.6973326225078340656615694E-02_r8,&
        3.0111675367556473004171380E-01_r8,    1.5387943765282155461626701E-01_r8,    3.2203120260084591892912886E-03_r8,&
        2.9726827957985696437859247E-01_r8,    1.9805413816430661455569862E-01_r8,   -3.5941252550752075811679731E-03_r8,&
        2.9976788831814599189939941E-01_r8,    1.9699622204619460230645700E-01_r8,    4.8834043669769046369655285E-02_r8,&
        3.5490586382185279612500040E-01_r8,    1.5132552155022896411828981E-01_r8,    4.7043367168007568790422113E-02_r8,&
        3.4925957053478384750633268E-01_r8,    1.5409207743424332970327839E-01_r8,    1.2734010271292757823791142E-03_r8,&
        3.5312328049032037924348515E-01_r8,    1.9723427154558312301979583E-01_r8,   -3.6805048546259722282159021E-03_r8,&
        3.4558753583462131775405624E-01_r8,    1.9959592599521741584922552E-01_r8,    5.1507993971782801978509525E-02_r8,&
        3.2393674605573619107445893E-01_r8,    1.9797013943782545974947595E-01_r8,    2.3266851882962669845200665E-02_r8,&
        3.2643988194160017402012386E-01_r8,    1.5333225744120468347908570E-01_r8,    2.4627601611555912514139877E-02_r8,&
        3.2518465692720482929090053E-01_r8,    1.7548741567979148081590779E-01_r8,    4.8589682758659435979353702E-02_r8,&
        3.2519197107013148029253102E-01_r8,    1.7581498119923866241265387E-01_r8,   -6.9522926414086120942836811E-04_r8,&
        2.9965756532694176605957637E-01_r8,    1.7574044774771191423923256E-01_r8,    2.3858389166445160417540094E-02_r8,&
        3.5071906267039454352385519E-01_r8,    1.7556194913131822898932910E-01_r8,    2.4036064328073418472353495E-02_r8],&
        [3,14])

    edge_vid = reshape([&
        1,   2,&
        2,   3,&
        3,   4,&
        4,   1,&
        1,   5,&
        2,   6,&
        3,   7,&
        4,   8,&
        5,   6,&
        6,   7,&
        7,   8,&
        8,   5,&
        3,   9,&
        4,   9,&
        8,   9,&
        7,   9,&
        1,  10,&
        2,  10,&
        6,  10,&
        5,  10,&
        1,  11,&
        5,  11,&
        8,  11,&
        4,  11,&
        2,  12,&
        3,  12,&
        7,  12,&
        6,  12,&
        1,  13,&
        4,  13,&
        3,  13,&
        2,  13,&
        5,  14,&
        6,  14,&
        7,  14,&
        8,  14], [2,36])

    face_vid = reshape([&
        3,   4,   9,   0,&
        1,   2,  10,   0,&
        1,   5,  11,   0,&
        2,   3,  12,   0,&
        1,   4,  13,   0,&
        5,   6,  14,   0,&
        4,   8,   9,   0,&
        8,   7,   9,   0,&
        7,   3,   9,   0,&
        2,   6,  10,   0,&
        6,   5,  10,   0,&
        5,   1,  10,   0,&
        5,   8,  11,   0,&
        8,   4,  11,   0,&
        4,   1,  11,   0,&
        3,   7,  12,   0,&
        7,   6,  12,   0,&
        6,   2,  12,   0,&
        4,   3,  13,   0,&
        3,   2,  13,   0,&
        2,   1,  13,   0,&
        6,   7,  14,   0,&
        7,   8,  14,   0,&
        8,   5,  14,   0], [4,24])

    call cell%init(ierr, x, face_vid, edge_vid, tesselate=.false.)
    P%normal = [-8.62173174011783394199E-01_r8,   -5.06415116287931565964E-01_r8,   -1.41826658117567665218E-02_r8]
    P%rho = -3.37733838416905907120E-01_r8

    vol = cell%volume_behind_plane(P, ierr)

  end subroutine messy_test2

  subroutine messy_test3()

    use plane_type

    integer :: ierr
    real(r8) :: vol
    real(r8), allocatable :: x(:,:)
    integer, allocatable :: edge_vid(:,:), face_vid(:,:)
    type(plane) :: P
    type(polyhedron) :: cell

    x = reshape([&
        3.0294314597872723515692428E-01_r8,   -4.8698773386538163343573160E-02_r8,    4.2663840737409246262057394E-03_r8,&
        3.0313444994905669460649733E-01_r8,   -5.2583664742924030033321969E-02_r8,   -5.0691788107640432803346897E-02_r8,&
        3.0141094719978767102475103E-01_r8,   -4.0324428053132290936111382E-03_r8,   -4.6760592230546627057208298E-02_r8,&
        2.9986494064738922205037852E-01_r8,   -1.2029354919210549171998403E-03_r8,    3.7610355517159960517248329E-03_r8,&
        3.5493261070279652491521460E-01_r8,   -5.3668524621266491814175481E-02_r8,    5.5356824906722761330674087E-04_r8,&
        3.4912164408069734644612936E-01_r8,   -4.6207893278627204525221828E-02_r8,   -5.2161974102794508856284494E-02_r8,&
        3.5051792537758669210390394E-01_r8,    3.2391057144246985892432900E-03_r8,   -4.5775838459160375637502227E-02_r8,&
        3.5004541518423110124658137E-01_r8,   -2.4127658829630250526820934E-03_r8,    3.7595245771467255754827441E-03_r8,&
        3.2545980710224869936197933E-01_r8,   -1.1022596164431525643523369E-03_r8,   -2.1253967640211070266875737E-02_r8,&
        3.2753296267781945028119139E-01_r8,   -5.0289714007338975898520061E-02_r8,   -2.4508452471906697761605542E-02_r8,&
        3.2694652812828600696448689E-01_r8,   -2.6495749845672184052958187E-02_r8,    3.0851281129177180601041997E-03_r8,&
        3.2604624165178208716753261E-01_r8,   -2.4896223778109939639424653E-02_r8,   -4.8847548225035480884415051E-02_r8,&
        3.0183837094374021958742560E-01_r8,   -2.6629454106674117774833377E-02_r8,   -2.2356240178182537614581804E-02_r8,&
        3.5115439883632793005574513E-01_r8,   -2.4762519517108005917549463E-02_r8,   -2.3406179933935233883346427E-02_r8],&
        [3,14])

    edge_vid = reshape([&
        1,   2,&
        2,   3,&
        3,   4,&
        4,   1,&
        1,   5,&
        2,   6,&
        3,   7,&
        4,   8,&
        5,   6,&
        6,   7,&
        7,   8,&
        8,   5,&
        3,   9,&
        4,   9,&
        8,   9,&
        7,   9,&
        1,  10,&
        2,  10,&
        6,  10,&
        5,  10,&
        1,  11,&
        5,  11,&
        8,  11,&
        4,  11,&
        2,  12,&
        3,  12,&
        7,  12,&
        6,  12,&
        1,  13,&
        4,  13,&
        3,  13,&
        2,  13,&
        5,  14,&
        6,  14,&
        7,  14,&
        8,  14], [2,36])

    face_vid = reshape([&
        3,   4,   9,   0,&
        1,   2,  10,   0,&
        1,   5,  11,   0,&
        2,   3,  12,   0,&
        1,   4,  13,   0,&
        5,   6,  14,   0,&
        4,   8,   9,   0,&
        8,   7,   9,   0,&
        7,   3,   9,   0,&
        2,   6,  10,   0,&
        6,   5,  10,   0,&
        5,   1,  10,   0,&
        5,   8,  11,   0,&
        8,   4,  11,   0,&
        4,   1,  11,   0,&
        3,   7,  12,   0,&
        7,   6,  12,   0,&
        6,   2,  12,   0,&
        4,   3,  13,   0,&
        3,   2,  13,   0,&
        2,   1,  13,   0,&
        6,   7,  14,   0,&
        7,   8,  14,   0,&
        8,   5,  14,   0], [4,24])

    call cell%init(ierr, x, face_vid, edge_vid, tesselate=.true.)
    P%normal = [-9.95982459629621175168E-01_r8,   -1.38360982818879841086E-03_r8,    8.95378452609466163326E-02_r8]
    P%rho = -3.52325570851871439082E-01_r8

    vol = cell%volume_behind_plane(P, ierr)
    print *, 'done'

  end subroutine messy_test3

end module polyhedron_type_test
